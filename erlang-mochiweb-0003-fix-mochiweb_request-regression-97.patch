From 97c19d17b208a25d262b7bacc203d122d1becd26 Mon Sep 17 00:00:00 2001
From: Bob Ippolito <bob@redivi.com>
Date: Fri, 25 Jan 2013 16:19:05 -0800
Subject: [PATCH 3/3] fix mochiweb_request regression #97

---
 CHANGES.md               | 2 ++
 src/mochiweb_request.erl | 4 +++-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/CHANGES.md b/CHANGES.md
index 2114a57..ae16240 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,5 +1,7 @@
 Version 2.4.1 released XXXX-XX-XX
 
+* Fixed issue in mochiweb_request introduced in v2.4.0
+  https://github.com/mochi/mochiweb/issues/97
 * Fixed issue in mochifmt_records introduced in v2.4.0
   https://github.com/mochi/mochiweb/issues/96
 
diff --git a/src/mochiweb_request.erl b/src/mochiweb_request.erl
index 0eacc71..1b431d3 100644
--- a/src/mochiweb_request.erl
+++ b/src/mochiweb_request.erl
@@ -306,7 +306,9 @@ respond({Code, ResponseHeaders, {file, IoDevice}},
         'HEAD' ->
             ok;
         _ ->
-            mochiweb_io:iodevice_stream(fun send/2, IoDevice)
+            mochiweb_io:iodevice_stream(
+              fun (Body) -> send(Body, THIS) end,
+              IoDevice)
     end,
     Response;
 respond({Code, ResponseHeaders, chunked}, {?MODULE, [_Socket, Method, _RawPath, Version, _Headers]}=THIS) ->
-- 
1.8.1

